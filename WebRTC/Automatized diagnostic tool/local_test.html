


<html>		
	<head>
		<script>
			var catchMissingSTUN = true;
			var catchMissingTURN = false;
		</script>
		<meta charset=utf-8 />
		<title>User-side</title>
		<style>		
			body {
				font-family: calibri, arial;
			}
			
			#container {
				position: fixed;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 500px;
				background: rgba(0, 0, 0, 0.2);
				padding-left: 20px;
				box-shadow: 0px 0px 5px #222222;
			}


			#rulediv {
				width: 500px;
				padding-right: 50px;
				float: left;
			}

		</style>
	</head>
	
	<video id="localVideo" hidden muted></video>
	
	<body bgcolor="#FFFFFF">
		<div id="container">
			<h2>Local test</h2>
		
			<p id="step">This is a serie of test to troubleshoot most of the errors that happen with WebRTC.<br>
				The current test will simulate a call on your computer.</p>
			
			<button id="button" onclick="test()">Initiate test</button>

			
		</div>
	</body>
	
	<script type="text/javascript">

				// Declaration des variables globales
		var localStream1;
		var remoteStream1;
		var localStream2;
		var remoteStream2;
		var pc1;
		var pc2;
		var offer;
		var answer;
		var browser;
		var ok1 = false;
		var ok2 = false;
		var timeoutID;
		var pc1DataChannel;
		var pc2DataChannel;
		
		if (navigator.userAgent.match(/Firefox/)) {
			browser = "firefox";
			if (navigator.userAgent.match(/Firefox\/([0-9]{2})/)[1] < 23) {
				handleError("MOZ_TOO_OLD");
			}
		}
		else {
			handleError("NOT_MOZ");
		}
		
		function test() {
			button.hidden = true;
			setResult("Getting user media...");
			navigator.mozGetUserMedia({video: true, audio: true},function(stream) {
				localStream1 = stream;
				setResult("Setting up fake stream");
				navigator.mozGetUserMedia({video: true, audio: true, fake: true},function(stream) {
					localStream2 = stream;
					setResult("Testing audio/video tracks...");
					if (localStream1.getAudioTracks().length == 0) {handleError("AUDIO_ERROR");}
					if (localStream1.getVideoTracks().length == 0) {handleError("VIDEO_ERROR");}
		
		
					setResult("Setting pc1...");
					pc1 = new mozRTCPeerConnection({ "iceServers": 
						[{"url": "turn:66.228.45.110:3478", "username": "aappzzxx@hotmail.fr", "credential": "apzx4906" }] });
					pc1.addStream(localStream1);
					pc1.onaddstream = success1;
		
					
					setResult("Setting pc2...");
					pc2 = new mozRTCPeerConnection({ "iceServers": 
						[{"url": "turn:66.228.45.110:3478", "username": "aappzzxx@hotmail.fr", "credential": "apzx4906" }] });
					pc2.addStream(localStream2);
					pc2.onaddstream = success2;
							
					setResult("Creating offer...");
					pc1.createOffer(function(descO) {
						offer = descO;
						console.log(offer.sdp)
						if (!offer.sdp.match(/srflx/) && catchMissingSTUN) {
							handleError("STUN_ERROR");
						}

						timeoutID = null;
						setResult("Setting pc1 localDescription...");
						pc1.setLocalDescription(offer);
						setResult("Setting pc2 remoteDescription...");
						pc2.setRemoteDescription(new mozRTCSessionDescription(offer));
						setResult("Creating answer...");
						pc2.createAnswer(function(descA) {
							answer = descA;
							if (!answer.sdp.match(/srflx/) && catchMissingTURN) {
								handleError("STUN_ERROR");
							}
							
							setResult("Setting pc2 localDescription...")
							pc2.setLocalDescription(answer);
							setResult("Setting pc1 remoteDescription...");
							pc1.setRemoteDescription(new mozRTCSessionDescription(answer));
						},handleError);
					},handleError,{});
				},handleError);
			},handleError);
		}
		
		
		
		function success1(event) {
		
			if (ok2) {
				setResult("Locally, there is no detected error<br>Redirecting to the second part of the test...",true);
				// window.location.href = window.location.href.replace("local_test.html","user_side.html");
			}
			else {
				ok1 = true;
				setResult("Success on local view. Waiting for remote...")
			}
		}
		
		
		function success2(event) {
			if (ok1) {
				setResult("Locally, there is no detected error<br>Redirecting to the second part of the test...",true);
				// window.location.href = window.location.href.replace("local_test.html","user_side.html");
			}
			else {
				ok2 = true;
				setResult("Success on remote view. Waiting for local...")
			}
		}
				
		
		
		function handleError (err) {
			switch (err) {
				case "NOT_MOZ":
					setResult("This test is engineered to be used on Firefox",false);
					break;

				case "MOZ_TOO_OLD":
					setResult("Your version of Firefox is not up to date<br>"+
						"Please update Firefox in <code>Help -> About Firefox</code>",false);
		
				case "AUDIO_ERROR":
					setResult("No sound is captured<ul>"+
						"<li>Check if your microphone is properly connected or muted</li>"+
						"</ul>",false);
					break;
		
				case "VIDEO_ERROR":
					setResult("No video is captured<ul>"+
						"<li>Check if your webcam is properly connected or disabled</li>"+
						"</ul>",false);
					break;
		
				case "PERMISSION_DENIED":
					setResult("The acess to the imput devices has been denied<br><ul>"+
						"<li>Check if there is any program that might block the use of the webcam</li>"+
						"</ul>",false);
					break;
		
				case "HARDWARE_UNAVAILABLE":
					setResult("Your input device(s) is/are alerady in use<br><ul>"+
						"<li>Close any other application that could use your webcam or microphone</li>"+
						"</ul>",false);
					break;

				case "NO_DEVICES_FOUND":
					setResult("Ther are no input devices detected<br><ul>"+
						"<li>Verify that your webcam and microphone are properly plugged</li>"+
						"<li>Make sure that the devices are not deactivated (Control pannel in Windows)</li>"+
						"</ul>",false);
					break;
		
				case "CONNECTION_ERROR":
					setResult("Could not connect to internet, check your connection",false);
					break;
		
				case "STUN_ERROR":
					setResult("Could not connect to the stun server",false);
					break;

				case "TURN_ERROR":
					setResult("Could not connect to the turn server",false);
					break;
					
		
				default:
					setResult("The following error occured:<br>"+err);
					console.log(err);
			}
			throw "This is not an error: Stop js execution";
		}
		
		
		
		function setResult(string, success) {
			document.getElementById("step").innerHTML = string;
			if (success === undefined) {}
			else if (success == true) {
				document.getElementById("step").style = "color:green"
			}
			else if (success == false) {
				document.getElementById("step").style = "color:red"
				
				button.onclick = function(){
					window.location.href = window.location.href;
				};
				button.innerHTML = 'Try again';
				button.hidden = false;
			}
		}

		function getURLParameter(name) {
			return decodeURIComponent(new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)')
					.exec(location.search)||[,""])[1].replace(/\+/g, '%20')||null;
		}	// Not my work

	</script>
</html>