<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>User-side</title>
		<style>		
			body {
				font-family: calibri, arial;
			}

			.question {
				cursor: pointer;
			}

			.answer {
				padding-left: 20px;
				font-size: 75%;
			}

			#openedQuestion {}

			#FAQdiv {
				height: 100%;
				width: 100%;
				overflow: auto;
				padding-top: -20px;
			}

			#localVideo {
				border: 1px solid black;
				position: fixed;
				height: 30%;
				max-width: 100%;
				bottom: 0px;
				right: 0px;
				z-index: 1;
				transform: rotateY(180deg);
			}
			
			#container {
				position: fixed;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 350px;
				background: rgba(0, 0, 255, 0.2);
				padding-left: 20px;
				box-shadow: 0px 0px 5px #222222;
			}

			#rulediv {
				width: 500px;
				padding-right: 50px;
				float: left;
			}

			#logdiv {
				position: fixed;
				left: 400px;
				top: 20px;
				overflow: hidden;
				height: 100%;
			}

			#recorddiv {
				line-height: 12px;
				float: left;
			}
		</style>
	</head>
	
	<video id="localVideo" hidden muted></video>
	
	<body bgcolor="#EEEEFF">
		<div id="container">
			<h2>User-side of my WebRTC tool</h2>
		
			<p id="step">Waiting for the user media...</p>
			
			<button id="button" hidden onclick="echoTest()">Execute test</button>

			
		</div>
		<div id="logdiv" hudden=true>
			<div id="rulediv">
				<b style="font-size: 125%">Welcome to the second part of the WebRTC diagnostic tool</b>
				<p>Welcome to the testing application for WebRTC</p>
				<p>This webpage is designed to simulate a call and allows you to see what your correspondant would be able to see.</p>
				<p>Please run the rest twice to make sure that the results are the same</p>
				<b>How to interpret the results:</b>
				<ul id="FAQdiv">
					<li class="question">The test is stuck</li>
						<div class="answer" hidden>
							Please refresh the webpage and rerun the test<br>
							If it still doesn't works, go back to <a href="local_test.html">this test</a> and run it
						</div>
					<li class="question">The recording I get is empty</li>
						<div class="answer" hidden>
							This might be linked to your connection, which is too restrictive<br>
							There is no current solutions. Contact your Network administrator
						</div>
					<li class="question">Test result/problem placeholder</li>
						<div class="answer" hidden>
							Answer placeholder<br>
							Solution placeholder
						</div>
				</ul>
			</div>
			<div id="recorddiv"><b>Recording:</b><br></div>
		</div>
	</body>

	<script type="text/javascript" src="jQuery.min.js"></script>
			
	<script type="text/javascript">
		var localStream;

		window.onload = function() {

			$('.question').click(function() {
				var toggle = $(this).nextUntil('.question');
				toggle.slideToggle();
				$('.answer').not(toggle).slideUp();
			});

			navigator.mozGetUserMedia({video: true, audio: true},function(stream){
				localStream = stream;
				step.innerHTML = "";
				localTest();
			},handleError);

		}	//onload


		function localTest() {


			var localStream1;
			var remoteStream1;
			var localStream2;
			var remoteStream2;
			var pc1;
			var pc2;
			var offer;
			var answer;
			var ok1 = false;
			var ok2 = false;
			var timeoutID;
			
			if (navigator.userAgent.match(/Firefox/)) {
				if (navigator.userAgent.match(/Firefox\/([0-9]{2})/)[1] < 23) {
					handleError("MOZ_TOO_OLD");
				}
			}
			else {
				handleError("NOT_MOZ");
			}
			
			localStream1 = localStream;
			setResult("Setting up fake stream...");
			navigator.mozGetUserMedia({video: true, audio: true, fake: true},function(stream) {
				localStream2 = stream;
				setResult("Testing audio/video tracks...");
				if (localStream1.getAudioTracks().length == 0) {handleError("AUDIO_ERROR");}
				if (localStream1.getVideoTracks().length == 0) {handleError("VIDEO_ERROR");}
			
				setResult("Setting pc1...");
				pc1 = new mozRTCPeerConnection();
				pc1.addStream(localStream1);
				pc1.onaddstream = function() {
					if (ok2) {
						setResult("The first test is a sucess<br>Please execute the second test", true);
						button.onclick = echoTest;
						button.hidden = false;
						button.innerHTML = "Execute test";
					}
					else {
						ok1 = true;
						setResult("Success on view 1. Waiting for view 2...");
					}
				};
			
				
				setResult("Setting pc2...");
				pc2 = new mozRTCPeerConnection();
				pc2.addStream(localStream2);
				pc2.onaddstream = function() {
					if (ok1) {
						setResult("The first test is a sucess<br>Please execute the second test", true);
						button.onclick = echoTest;
						button.hidden = false;
						button.innerHTML = "Execute test";
					}
					else {
						ok2 = true;
						setResult("Success on view 2. Waiting for view 1...");
					}
				};
						
				setResult("Creating offer...");
				pc1.createOffer(function(descO) {
					offer = descO;
					if (!offer.sdp.match(/srflx/) && false) {
						handleError("STUN_ERROR");
					}

					timeoutID = null;
					setResult("Setting pc1 localDescription...");
					pc1.setLocalDescription(offer);
					setResult("Setting pc2 remoteDescription...");
					pc2.setRemoteDescription(new mozRTCSessionDescription(offer));
					setResult("Creating answer...");
					pc2.createAnswer(function(descA) {
						answer = descA;
						if (!answer.sdp.match(/srflx/) && false) {
							handleError("STUN_ERROR");
						}
						
						setResult("Setting pc2 localDescription...")
						pc2.setLocalDescription(answer);
						setResult("Setting pc1 remoteDescription...");
						pc1.setRemoteDescription(new mozRTCSessionDescription(answer));
						button.hidden = false;
					},handleError);
				},handleError);
			},handleError);

			function setResult(string, success) {
				step.innerHTML = string;
				if (success === undefined) {
					step.style = "";
				}
				else if (success == true) {
					step.style = "color:green"
				}
				else if (success == false) {
					step.style = "color:red"
					
					button.onclick = function(){
						window.location.href = window.location.href;
					};
					button.innerHTML = 'Try again';
					button.hidden = false;
				}
			}
	
		}	// localTest


		function echoTest() {
			button.hidden = true;

			var remoteStream;
			var peerConnection;
			var dataChannel;
			var offer;

			var key;
			
			var ip = '127.0.0.1:8080';

			var	timeoutAnswer,
				timeoutDisconnect;

			var flagPing = false;

			var recordingResult = [];
			var param = {empty:true};

			localVideo.src = URL.createObjectURL(localStream);
			localVideo.play();
			localVideo.hidden = false;
			setResult("");

			peerConnection = new mozRTCPeerConnection();
			peerConnection.addStream(localStream);
			peerConnection.onaddstream = playRemoteStream;
			dataChannel = peerConnection.createDataChannel('channel', {});
			dataChannel.binaryType = 'blob';
			dataChannel.onmessage = onDataChannelMessage;

			key = Math.floor(Math.random()*1000000)*10;

			setResult("Creating offer...");
			peerConnection.createOffer(function(tmp2) {
				offer = tmp2;
				setResult("Setting local description...");
				peerConnection.setLocalDescription(offer, function() {
					setResult("Setting up connection to the signaling server...");
					connection = new EventSource("user_connect?key="+key);

					connection.addEventListener("connected", function(event) {
						setResult("Sending offer...");
						$.post('http://'+ip+'/send_offer?key='+key,
							{"type":offer.type,"sdp":offer.sdp});
						setResult("Waiting for answer...");
					}, false);

					connection.addEventListener("updateQueue", function(event) {
						var tmp = JSON.parse(event.data);
						if (tmp.position == 0) {
							setResult("Waiting for answer...<br>"+
									"You are being processed for a connection");
						}
						else {
							setResult("Waiting for answer...<br>"+
								"You are queued "+tmp.position+"/"+tmp.queue+"<br>"+
								"The server can currently host "+tmp.capacity+" connections");
						}
					}, false);

					connection.addEventListener("error", function(event) {
						console.log("event fired: error"); //Debug marker
						reset();
						setResult("An error happened while trying to process your call",false);
						button.onclick = echoTest;
					}, false);
					
					connection.addEventListener("answer", function(event) {
						peerConnection.setRemoteDescription(new mozRTCSessionDescription(JSON.parse(event.data)));
						setResult("Setting up peerConnection...");
						connection.close();
					}, false);

					
				}, console.error);
			}, console.error);



			function playRemoteStream(event) {
				setResult("Setting up dataChannel...");

				remoteStream = event.stream;
				
				timeoutDisconnect = setTimeout(function() {
					reset();
					setResult("DataChannel could not be etablished",false);
				},10011);
			}	// playRemoteStream



			function onDataChannelMessage (event) {
				
				if (event.data == "ping") {
					dataChannel.send("pong");

					if (!flagPing) {
						setResult("<font color='red' id='recordChar'>‚óè</font>  Recording...");
						doBlink("recordChar");
						flagPing = true;
						setTimeout(function(){setResult("Setting up replay...");},4000);
					}


					if (timeoutDisconnect != null) {
						clearTimeout(timeoutDisconnect);
						timeoutDisconnect = setTimeout(function() {
							reset();
							setResult("Connection Timeout",false);
						},5011);
					}
				}

				else if (event.data.match(/^recording_ended:(.+)$/)) { //end of the video recording
					param = JSON.parse(RegExp.$1);
					param.empty = false;
				}

				
				else if (param.empty == true) {

					if (timeoutDisconnect != null) {
						clearTimeout(timeoutDisconnect);
						timeoutDisconnect = setTimeout(function() {
							reset();
							setResult("Connection Timeout",false);
						},5011);
					}

					recordingResult.push(event.data);
				}

				else if (param.empty != true) {
					recorddiv.innerHTML += '<font size="0.5">Click on the picture to play the recoding</font><br>';
					var img = document.createElement('img');
					img.width = param.width;
					img.height = param.height;
					img.style = "border: 1px solid black;transform: rotateY(180deg);";
					var sound = document.createElement('audio');
					var randomnumber = Math.floor(Math.random()*1000000)*10+2;
					sound.id = randomnumber;
					img.audiosrc = randomnumber;
					sound.src = event.data;
					sound.preload = 'auto';
					img.videoArray = recordingResult;
					img.src = img.videoArray[0];
					img.onclick = function() {
						document.getElementById(img.audiosrc).play();
						var i = 0;
						var intervalFrame = setInterval(function(){
							img.src = img.videoArray[i];
							i++;
							if (i>=img.videoArray.length) {
								if (i == 1) {
									recorddiv.innerHTML = "<font color='red'>There is no video to display</font>";
									img.style = "";
								}
								clearInterval(intervalFrame);
								img.src = img.videoArray[0];
							}
						},1000/param.FPS);
					};

					
					recorddiv.appendChild(sound);
					recorddiv.appendChild(img);

					img.onclick();


					
					setResult("Test finished",true);
					dataChannel.send("conversationEnded");
					peerConnection.close();
					clearTimeout(timeoutDisconnect);

				}	// play recording

				else {
					console.log("mesage: ",event.data);
				}


			}	// onDataChannelMessage



			function reset() {
				remoteStream = null;
				
				try{dataChannel.send("conversationEnded");}catch(e){}

				if (peerConnection != null) {peerConnection.close();}
				peerConnection = null;

				if (timeoutAnswer != null) {clearInterval(timeoutAnswer);}
				timeoutAnswer = null;

				if (timeoutDisconnect != null) {clearTimeout(timeoutDisconnect);}
				timeoutDisconnect = null;
				

				$.post('http://'+ip+'/reset?key='+key);
				
				key = null;

				recordingResult = [];
			}	// reset

			function setResult(string, success) {
				step.innerHTML = string;
				if (success === undefined) {
					step.style = "";
				}
				else if (success == true) {
					step.style = "color:green"
				}
				else if (success == false) {
					step.style = "color:red"
					
					button.onclick = echoTest;
					button.innerHTML = 'Try again';
					button.hidden = false;
				}
			}

		}	// echoTest


				
		function doBlink(id) {
			$("#"+id).fadeTo(500,0);
			setTimeout(function(){
				$("#"+id).fadeTo(500,1);
				setTimeout(doBlink,750,id);
			},500);
		}


		function handleError (err) {
			switch (err) {
				case "NOT_MOZ":
					setResult("This test is engineered to be used on Firefox",false);
					break;

				case "MOZ_TOO_OLD":
					setResult("Your version of Firefox is not up to date<br>"+
						"Please update Firefox in <code>Help -> About Firefox</code>",false);
		
				case "AUDIO_ERROR":
					setResult("No sound is captured<ul>"+
						"<li>Check if your microphone is properly connected or muted</li>"+
						"</ul>",false);
					break;
		
				case "VIDEO_ERROR":
					setResult("No video is captured<ul>"+
						"<li>Check if your webcam is properly connected or disabled</li>"+
						"</ul>",false);
					break;
		
				case "PERMISSION_DENIED":
					setResult("The acess to the imput devices has been denied<br><ul>"+
						"<li>Check if there is any program that might block the use of the webcam</li>"+
						"</ul>",false);
					break;
		
				case "HARDWARE_UNAVAILABLE":
					setResult("Your input device(s) is/are alerady in use<br><ul>"+
						"<li>Close any other application that could use your webcam or microphone</li>"+
						"</ul>",false);
					break;

				case "NO_DEVICES_FOUND":
					setResult("Ther are no input devices detected<br><ul>"+
						"<li>Verify that your webcam and microphone are properly plugged</li>"+
						"<li>Make sure that the devices are not deactivated (Control pannel in Windows)</li>"+
						"</ul>",false);
					break;
		
				case "CONNECTION_ERROR":
					setResult("Could not connect to internet, check your connection",false);
					break;
		
				case "STUN_ERROR":
					setResult("Could not connect to the stun server",false);
					break;

				case "TURN_ERROR":
					setResult("Could not connect to the turn server",false);
					break;
					
		
				default:
					setResult("The following error occured:<br>"+err,false);
			}
			throw "This is not an error: Stop js execution";
		}


	</script>
</html>