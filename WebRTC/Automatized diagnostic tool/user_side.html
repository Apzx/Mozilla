<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>User-side</title>
		<style>		
			body {
				font-family: calibri, arial;
			}

			.question {
				cursor: pointer;
			}

			.answer {
				padding-left: 20px;
				font-size: 75%;
			}

			#openedQuestion {}

			#FAQdiv {
				height: 100%;
				width: 100%;
				overflow: auto;
				padding-top: -20px;
			}

			#localVideo {
				border: 1px solid black;
				position: fixed;
				height: 30%;
				max-width: 100%;
				bottom: 0px;
				right: 0px;
				z-index: 1;
				transform: rotateY(180deg);
			}
			
			#container {
				position: fixed;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 350px;
				background: rgba(0, 0, 255, 0.2);
				padding-left: 20px;
				box-shadow: 0px 0px 5px #222222;
			}

			#rulediv {
				width: 500px;
				padding-right: 50px;
				float: left;
			}

			#logdiv {
				position: fixed;
				left: 400px;
				top: 20px;
				overflow: hidden;
				height: 100%;
			}

			#recorddiv {
				line-height: 12px;
				float: left;
			}
		</style>
	</head>
	
	<video id="localVideo" hidden muted></video>
	
	<body bgcolor="#EEEEFF">
		<div id="container">
			<h2>User-side of my WebRTC tool</h2>
		
			<p id="step">Waiting for the user medias (Audio + video)</p>
			
			<button id="button" hidden onclick="start()">Initiate test</button>

			
		</div>
		<div id="logdiv" hudden=true>
			<div id="rulediv">
				<b style="font-size: 125%">Welcome to the second part of the WebRTC diagnostic tool</b>
				<p>Welcome to the testing application for WebRTC</p>
				<p>This webpage is designed to simulate a call and allows you to see what your correspondant would be able to see.</p>
				<p>Please run the rest twice to make sure that the results are the same</p>
				<b>How to interpret the results:</b>
				<ul id="FAQdiv">
					<li class="question">The test is stuck</li>
						<div class="answer" hidden>
							This test was designed to work with an already working system<br>
							Go back to <a href="local_test.html">this test</a> and run it
						</div>
					<li class="question">The recording I get is empty</li>
						<div class="answer" hidden>
							This might be linked to your connection, which is too restrictive<br>
							There is no current solutions. Contact your Network administrator
						</div>
					<li class="question">Test result/problem placeholder</li>
						<div class="answer" hidden>
							Answer placeholder<br>
							Solution placeholder
						</div>
				</ul>
			</div>
			<div id="recorddiv"><b>Recording:</b><br></div>
		</div>
	</body>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
			
	<script type="text/javascript">

		var localStream;
		var remoteStream;
		var peerConnection;
		var dataChannel;

		var key;
		
		var ip = '127.0.0.1:8080';

		var	timeoutAnswer,
			timeoutDisconnect;

		var flagPing = false;

		var recordingResult = [];
		var param = {empty:true};



		window.onload = function() {

			$('.question').click(function() {
				var toggle = $(this).nextUntil('.question');
				toggle.slideToggle();
				$('.answer').not(toggle).slideUp();
			});

			
			navigator.mozGetUserMedia({video: true, audio: true},function(stream){
				localStream = stream;
				localVideo.src = URL.createObjectURL(localStream);
				localVideo.play();
				$("#localVideo").show();
				step.innerHTML = "";

				$("#button").show();
			},console.error);
		}	//onload


		function start() {
			$("#button").hide();

			peerConnection = new mozRTCPeerConnection();
			peerConnection.addStream(localStream);
			peerConnection.onaddstream = playRemoteStream;
			dataChannel = peerConnection.createDataChannel('channel', {});
			dataChannel.binaryType = 'blob';
			dataChannel.onmessage = onDataChannelMessage;

			key = Math.floor(Math.random()*1000000)*10;

			step.innerHTML = "Creating offer...";
			peerConnection.createOffer(function(offer) {
				step.innerHTML = "Setting local description...";
				peerConnection.setLocalDescription(offer, function() {
					step.innerHTML = "Sending offer...";
					$.post('http://'+ip+'/send_offer',
						{"key":key,"offer":{"type":offer.type,"sdp":offer.sdp}});
					step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...";
					askAnswer();
				}, console.error);
			}, console.error);
		}	// start



		function askAnswer(adress){
			$.ajax({
				url: 'http://'+ip+'/ask_for_answer?key='+key,
				dataType: "jsonp",
				jsonpCallback: "callback",
				success: function(data) {
					var answer = data.replace(/\r\n/g,"\\r\\n");
					if (answer.match(/^Nope\.avi_capacity:([0-9]+)_queue:([0-9]+)_pos:([0-9]+)$/)) {
						timeoutAnswer = setTimeout(askAnswer,2001);
						if (RegExp.$3 == 0) {
							step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...<br>"+
								"You are being processed for a connection";
						}
						else {
							step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...<br>"+
								"You are queued "+RegExp.$3+"/"+RegExp.$2+"<br>"+
								"The server can currently host "+RegExp.$1+" connections";
						}
					}
					else if (answer == 'reset_please') {
						reset();
						step.innerHTML = "<font color='red'>An error happened while trying to process your call<br>Please try again</font>";
					}
					else {
						peerConnection.setRemoteDescription(new mozRTCSessionDescription(JSON.parse(answer)));
					}
				},
			});
		}	// askAnswer



		function playRemoteStream(event) {
			step.innerHTML = "The test is underway<br>You are user <code>"+key+"</code>";

			remoteStream = event.stream;
			
			timeoutDisconnect = setTimeout(function() {
				reset();
				step.innerHTML = "<font color='red'>DataChannel could not be etablished</font>";
			},10011);
		}	// playRemoteStream



		function onDataChannelMessage (event) {
			
			if (event.data == "ping") {
				dataChannel.send("pong");

				if (!flagPing) {
					step.innerHTML = "<font color='red' id='recordChar'>‚óè</font>  Recording...";
					doBlink("recordChar");
					setTimeout(function(){step.innerHTML = "Recording finished<br>Setting up video..."},4000);
					flagPing = true;
				}


				if (timeoutDisconnect != null) {
					clearTimeout(timeoutDisconnect);
					timeoutDisconnect = setTimeout(function() {
						reset();
						step.innerHTML = "<font color='red'>Connection Timeout</font>";
					},5011);
				}
			}

			else if (event.data.match(/^recording_ended:(.+)$/)) { //end of the video recording, end of the test
				param = JSON.parse(RegExp.$1);
				param.empty = false;
			}

			
			else if (param.empty == true) {

				if (timeoutDisconnect != null) {
					clearTimeout(timeoutDisconnect);
					timeoutDisconnect = setTimeout(function() {
						reset();
						step.innerHTML = "<font color='red'>Connection Timeout</font>";
					},5011);
				}

				recordingResult.push(event.data);
			}

			else if (param.FPS != undefined) {
				recorddiv.innerHTML += '<font size="0.5">Click on the picture to play the recoding</font><br>';
				var img = document.createElement('img');
				img.width = param.width;
				img.height = param.height;
				img.style = "border: 1px solid black;";
				var sound = document.createElement('audio');
				var randomnumber = Math.floor(Math.random()*1000000)*10+2;
				sound.id = randomnumber;
				img.audiosrc = randomnumber;
				sound.src = event.data;
				sound.preload = 'auto';
				img.videoArray = recordingResult;
				img.src = img.videoArray[0];
				img.onclick = function() {
					document.getElementById(img.audiosrc).play();
					var i = 0;
					var intervalFrame = setInterval(function(){
						img.src = img.videoArray[i];
						i++;
						if (i>=img.videoArray.length) {
							if (i == 1) {
								recorddiv.innerHTML = "<font color='red'>There is no video to display</font>";
								img.style = "";
							}
							clearInterval(intervalFrame);
							img.src = img.videoArray[0];
						}
					},1000/param.FPS);
				};

				
				recorddiv.appendChild(sound);
				recorddiv.appendChild(img);

				img.onclick();

				recordingResult = [];

				setTimeout(reset,500);

			}	// play recording

			else {
				console.log("mesage: ",event.data);
			}


		}	// onDataChannelMessage
		function reset() {
			remoteStream = null;

			step.innerHTML = "Test finished";
			
			dataChannel.send("conversationEnded");

			if (peerConnection != null) {peerConnection.close();}
			peerConnection = null;

			if (timeoutAnswer != null) {clearInterval(timeoutAnswer);}
			timeoutAnswer = null;

			if (timeoutDisconnect != null) {clearTimeout(timeoutDisconnect);}
			timeoutDisconnect = null;
			

			$.post('http://'+ip+'/reset?key='+key);
			
			key = null;

			recordingResult = [];
		}	// reset
				
		function doBlink(id) {
			$("#"+id).fadeTo(500,0);
			setTimeout(function(){
				$("#"+id).fadeTo(500,1);
				setTimeout(doBlink,750,id);
			},500);
		}
		
	</script>
</html>