<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>User-side</title>
		<style>		
			body {
				font-family: calibri, arial;
			}

			#localVideo {
				border: 1px solid black;
				position: fixed;
				height: 30%;
				max-width: 100%;
				bottom: 0px;
				right: 0px;
				z-index: 1;
				transform: rotateY(180deg);
			}

			
			#container {
				position: fixed;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 350px;
				background: rgba(0, 0, 255, 0.2);
				padding-left: 20px;
				box-shadow: 0px 0px 5px #222222;
			}


			#rulediv {
				width: 500px;
				padding-right: 50px;
				float: left;
			}

			#logdiv {
				position: fixed;
				left: 400px;
				top: 20px;
				overflow: hidden;
				height: 100%;
			}

			#recorddiv {
				width: 200px;
				height: 95%;
				line-height: 12px;
				overflow-y: auto;
				float: left;
			}
		</style>
	</head>
	
	<video id="localVideo" hidden muted></video>
	
	<body bgcolor="#EEEEFF">
		<div id="container">
			<h2>User-side of my WebRTC tool</h2>
		
			<p id="step">Waiting for the user medias (Audio + video)</p>
			
			<button id="button" hidden=true></button>
			<br><br><br>
			<button id="recordAudioButton" hidden></button>
			<button id="takePhotoButton" hidden></button>
			<button id="recordVideoButton" hidden></button><br>
			<button id="clearRecordingButton" hidden>Clear recordings</button>

			
		</div>
		<div id="logdiv" hudden=true>
			<div id="rulediv">
				<b style="font-size: 125%">Welcome to the second part of the WebRTC diagnostic tool</b>
				<p>This webpage is designed to be used as an echo server.</p>
				<p>It will call a bot, and you will have the option to get a feedback of either the audio or the video recieved by the callee.</p>
				<p>The controls are in the sidebar.</p>
				<p>
					Once you connect to the recording bot, you will be able to request a recording of what the callee would see or hear. You can record:
					<ul>
						<li>A photo</li>
						<li>A short audio recording</li>
						<li>A short video</li>
					</ul>
					These recordings will be displayed in the recordings tab to be replayed
				</p>
			</div>
			<div id="recorddiv"><b>Recordings:</b></div>
		</div>
	</body>

	<script type="text/javascript"
			src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
			
	<script type="text/javascript">
		
		var localStream,
			remoteStream,
			offer,
			answer,
			peerConnection,
			dataChannel;

		var key;
		
		var flagmessage = false;

		var ip = '127.0.0.1:8080';

		var	timeoutSTUN,
			timeoutAnswer,
			timeoutDisconnect;

		var recordingResult = [];
				


		window.onload = function() {
			navigator.mozGetUserMedia({video: true, audio: true},function(stream){
				localStream = stream;
				localVideo.src = URL.createObjectURL(localStream);
				localVideo.play();
				localVideo.hidden = false;
				step.innerHTML = "";
			
				button.hidden = false;
				button.onclick = start;
				button.innerHTML = "Initiate call";
			},console.error);
		}	//onload



		function start() {
			button.onclick = reset;
			button.innerHTML = "Reset";

			peerConnection = new mozRTCPeerConnection();
			peerConnection.addStream(localStream);
			peerConnection.onaddstream = playRemoteStream;
			dataChannel = peerConnection.createDataChannel('channel', {});
			dataChannel.binaryType = 'blob';
			dataChannel.onmessage = onDataChannelMessage;

			key = Math.floor(Math.random()*1000000);

			step.innerHTML = "Creating offer...";

			// Creating a timeout to check if the connection to the STUN server is taking too long
			timeoutSTUN = setTimeout(function(){
				var tmpkey = key;
				reset();
				key = tmpkey;

				step.innerHTML = "<font color='red'>Could not connect to stun server</font>";
				button.innerHTML = "Try again";
				throw "Stop Execution (Not an error)";
			},5000);
			peerConnection.createOffer(function(localDesc) {
				offer = localDesc;
				clearTimeout(timeoutSTUN);
				timeoutSTUN = null;
				peerConnection.setLocalDescription(localDesc, function() {
					step.innerHTML = "Sending offer...";
					$.post('http://'+ip+'/send_offer',
						{"key":key,"offer":{"type":offer.type,"sdp":offer.sdp}});
					step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...";
					askAnswer();
				}, console.error);
			}, console.error);
		}	// start



		function onDataChannelMessage (event) {
			if (event.data == "ping") {
				dataChannel.send("pong_"+key);

				if (timeoutDisconnect != null) {clearTimeout(timeoutDisconnect);}

				timeoutDisconnect = setTimeout(function() {
					reset();
					step.innerHTML = "<font color='red'>Connection Timeout</font>";
				},5011);
			}

			else if (event.data == "conversationEnded_"+key) {
				flagmessage = true;
				console.log(event.data)
				reset();
			}

			/*else if (event.data == "stream_frozen") {
				var p = document.createElement('p');
				p.innerHTML = "<font color='red' size=0.5>The remote stream seems to be frozen</font>";
				recorddiv.appendChild(p);
			}*/

			else if (recordingType == 'audio') {
				recordingType = null;
				recorddiv.innerHTML += "<br><br>";
				
				var audioElement = document.createElement('audio');
				audioElement.controls = "controls";
				audioElement.style = "width: 160px;";

				recorddiv.innerHTML = recorddiv.innerHTML.replace('<font size="0.5">Click on the picture to play the recoding</font>','');

				audioElement.src = event.data;
				recorddiv.appendChild(audioElement);
				
				recorddiv.innerHTML += "<br>";

				takePhotoButton.disabled = false;
				recordAudioButton.disabled = false;
				recordVideoButton.disabled = false;
				recordAudioButton.innerHTML = "Record audio!";

				recorddiv.scrollTop = recorddiv.scrollHeight;
			}	// recordingType == 'audio'

			else if (event.data == "recording_ended") { //end of the video recording
				recordingType = null;
				recorddiv.innerHTML += "<br><br>";

				var img = document.createElement('img');
				img.width = 160;
				img.height = 120;
				img.style = "border: 1px solid black;"
				var sound = document.createElement('audio');
				var randomnumber = Math.floor(Math.random()*1000000)*10;
				sound.id = randomnumber;
				img.audiosrc = randomnumber;
				sound.src = recordingResult.shift();
				sound.preload = 'auto';
				img.videoArray = recordingResult;
				img.src = img.videoArray[0];
				img.onclick = function() {
					if (typeof intervalFrame != undefined) {clearInterval(intervalFrame);}
					document.getElementById(img.audiosrc).play();
					var i = 0;
					var intervalFrame = setInterval(function(){
						img.src = img.videoArray[i];
						i++;
						if (i>=img.videoArray.length) {
							clearInterval(intervalFrame);
							img.src = img.videoArray[0];
						}
					},100);
				};
				recorddiv.innerHTML = recorddiv.innerHTML.replace('<font size="0.5">Click on the picture to play the recoding</font>','');
				recorddiv.innerHTML += '<font size="0.5">Click on the picture to play the recoding</font>';
				recorddiv.appendChild(img);
				recorddiv.appendChild(sound);

				img.onclick();

				recordingResult = [];

				takePhotoButton.disabled = false;
				recordAudioButton.disabled = false;
				recordVideoButton.disabled = false;
				recordVideoButton.innerHTML = "Record video!";

				recorddiv.scrollTop = recorddiv.scrollHeight;
			}	// event.data == "recording_ended"


			else if (recordingType == 'video') {
				recordingResult.push(event.data);
			}


			else if (recordingType == "photo") {
				recordingType = null;
				recorddiv.innerHTML += "<br><br>";

				var img = document.createElement('img');
				img.src = event.data;
				img.height = 120;
				img.width = 160;
				img.style = "border: 1px solid black;"

				recorddiv.innerHTML = recorddiv.innerHTML.replace('<font size="0.5">Click on the picture to play the recoding</font>','');
				recorddiv.appendChild(img);

				takePhotoButton.disabled = false;
				recordAudioButton.disabled = false;
				recordVideoButton.disabled = false;
				takePhotoButton.innerHTML = 'Take photo!';

				recorddiv.scrollTop = recorddiv.scrollHeight;
			}

			else {
				console.log("Unexpected message: ", event.data);
			}
		}	// onDataChannelMessage
	


		function askAnswer(adress){
			$.ajax({
				url: 'http://'+ip+'/ask_for_answer?key='+key,
				dataType: "jsonp",
				jsonpCallback: "callback",
				success: function(data) {
					answer = data.replace(/\r\n/g,"\\r\\n");
					if (answer.match(/^Nope\.avi_capacity:([0-9]+)_queue:([0-9]+)_pos:([0-9]+)$/)) {
						timeoutAnswer = setTimeout(askAnswer,2001);
						if (RegExp.$3 == 0) {
							step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...<br>"+
								"You are being processed for a connection";
						}
						else {
							step.innerHTML = "Asking for answer with key \"<code>" + key + "</code>\" ...<br>"+
								"You are queued "+RegExp.$3+"/"+RegExp.$2+"<br>"+
								"The server can currently host "+RegExp.$1+" connections";
						}
					}
					else if (answer == 'reset_please') {
						reset();
						step.innerHTML = "<font color='red'>An error happened while trying to process your call<br>Please try again</font>";
					}
					else {
						peerConnection.setRemoteDescription(new mozRTCSessionDescription(JSON.parse(answer)));
					}
				}
			});
		}	// askAnswer



		function playRemoteStream(event) {
			step.innerHTML = "The call is now active<br>You are user <code>"+key+"</code>";

			remoteStream = event.stream;
		
			button.hidden = false;
			button.onclick = reset;
			button.innerHTML = "Reset";

			clearRecordingButton.hidden = false;
			clearRecordingButton.innerHTML = "Clear recordings";
			clearRecordingButton.onclick = function(){
				recorddiv.innerHTML = "<b>Recordings:</b>";
			};

			recordAudioButton.hidden = false;
			recordAudioButton.innerHTML = "Record audio!";
			recordAudioButton.onclick = function(){
				dataChannel.send('recordAudio_'+key);

				takePhotoButton.disabled = true;
				recordAudioButton.disabled = true;
				recordVideoButton.disabled = true;

				recordAudioButton.innerHTML = "Recording audio...";
				recordingType = "audio";
			};

			recordVideoButton.hidden = false;
			recordVideoButton.innerHTML = "Record video!";
			recordVideoButton.onclick = function() {
				dataChannel.send('recordVideo_'+key);

				takePhotoButton.disabled = true;
				recordAudioButton.disabled = true;
				recordVideoButton.disabled = true;

				recordVideoButton.innerHTML = "Recording video...";
				recordingType = "video";
			};


			takePhotoButton.hidden = false;
			takePhotoButton.innerHTML = "Take photo!";
			takePhotoButton.onclick = function(){
				dataChannel.send('takePhoto_'+key);

				takePhotoButton.disabled = true;
				recordAudioButton.disabled = true;
				recordVideoButton.disabled = true;

				takePhotoButton.innerHTML = "Waiting for photo...";
				recordingType = "photo";
			};
			
			timeoutDisconnect = setTimeout(function() {
				reset();
				step.innerHTML = "<font color='red'>DataChannel could not be etablished</font>";
			},10011);
		}	// playRemoteStream



		function reset() {
			remoteStream = null;

			offer = null;
			answer = null;	
			
			if (!flagmessage) {
				try{dataChannel.send("conversationEnded_"+key);}
				catch(err){}
			}

			flagmessage = false;

			if (peerConnection.close) {peerConnection.close();}
			peerConnection = null;

			if (timeoutAnswer != null) {clearInterval(timeoutAnswer);}
			timeoutAnswer = null;

			if (timeoutSTUN != null) {clearTimeout(timeoutSTUN);}
			timeoutSTUN = null;

			if (timeoutDisconnect != null) {clearTimeout(timeoutDisconnect);}
			timeoutDisconnect = null;
			
			recorddiv.innerHTML = "<b>Recordings:</b>";

			$.post('http://'+ip+'/reset?key='+key);
			
			key = null;

			recordingType = null;
		
			step.innerHTML = "";
			button.onclick = start;
			button.innerHTML = "Initiate call";

			takePhotoButton.hidden = true;
			takePhotoButton.disabled = false;
			takePhotoButton.innerHTML = "Take photo!";
			takePhotoButton.onclick = function(){};

			recordAudioButton.hidden = true;
			recordAudioButton.disabled = false;
			recordAudioButton.innerHTML = "Record audio!";
			recordAudioButton.onclick = function(){};

			recordVideoButton.hidden = true;
			recordVideoButton.disabled = false;
			recordVideoButton.innerHTML = "Record video!";
			recordVideoButton.onclick = function(){};

			clearRecordingButton.hidden = true;
			clearRecordingButton.disabled = false;
			clearRecordingButton.innerHTML = "Clear recordings";
			clearRecordingButton.onclick = function(){};

			recordingResult = [];
		}	// reset
				
			
		
	</script>
</html>