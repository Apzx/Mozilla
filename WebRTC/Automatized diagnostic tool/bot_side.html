<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript">
			var MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS = 2;
			var ip = '127.0.0.1:8080';
			
			var recordLength = 4; // in seconds
			var recordFPS = 10;
			var recordHeight = 120;
			var recordWidth = 160;

		</script>
		<meta charset=utf-8 />
		<title>Bot-side</title>
	</head>
	<body id='body'>Bot connecting...</body>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript">


		var localStream,
			timeoutOffer,
			glob = {},
			botKey;
		

		window.onload = function() {

			$.ajax({
				url: 'http://'+ip+'/connect?capacity='+MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS,
				dataType: "jsonp",
				jsonpCallback: "callback",
				success: function(data) {
					botKey = data+'';
					body.innerHTML = "<b>Connected to signaling server with id: <code>"+botKey+"</code><b><br>"
					navigator.mozGetUserMedia({video: true, audio: true, fake: true},function(stream) {
						localStream = stream;
						askOffer();
					},console.error);
				}
			});
			

		}	// onload
			



		function askOffer() {
			if (body.getElementsByTagName('div').length < MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS) {
				$.ajax({
					url: 'http://'+ip+'/ask_for_offer?key='+botKey,
					dataType: "jsonp",
					jsonpCallback: "callback",
					success: function(data) {
						if (data == "Nope.avi") {
							timeoutOffer = setTimeout(askOffer,2501);
						}
						else if (data == "reset_please") {
							window.location.href = window.location.href;
						}
						else {
							gotOffer(data);
						}
					}
				});
			}
			else {
				$.ajax({
					url: 'http://'+ip+'/botKeepalive?key='+botKey,
					dataType: "jsonp",
					jsonpCallback: "callback",
					success: function(data) {
						if (data == "reset_please") {
							window.location.href = window.location.href;
						}
						else {
							timeoutOffer = setTimeout(askOffer,2501);
						}
					}
				});
			}
		}	// askOffer
			
			

		function gotOffer(data) {
			var key = data["key"];

			glob[key] = {
					remoteVideo: null,
					remoteStream: null,
					peerConnection: null,
					dataChannel: null,

					pingInterval: null,
					timeoutDisconnect: null,

					canvasVideo: null,
					contextVideo: null,

					notif: null,

					flagping: false,
				};

			glob[key].remoteVideo = document.createElement('video');
			glob[key].remoteVideo.hidden = true;
			glob[key].remoteVideo.muted = true;
			glob[key].remoteVideo.id = "video_"+key;
			body.appendChild(glob[key].remoteVideo);

			glob[key].notif = document.createElement('div');
			glob[key].notif.id = "notif_"+key;
			glob[key].notif.innerHTML = "\""+key+"\" connected";
			body.appendChild(glob[key].notif);

			glob[key].canvasVideo = document.createElement('canvas');
			glob[key].canvasVideo.id = "canvasVideo_"+key;
			glob[key].canvasVideo.width = recordWidth;
			glob[key].canvasVideo.height = recordHeight;

			glob[key].contextVideo = glob[key].canvasVideo.getContext('2d');


			glob[key].peerConnection = new mozRTCPeerConnection();
			glob[key].peerConnection.unofficialID = key;
			glob[key].peerConnection.addStream(localStream);
			glob[key].peerConnection.onaddstream = gotRemoteStream;
			glob[key].peerConnection.ondatachannel = function (event) {
				glob[key].dataChannel = event.channel;
				glob[key].dataChannel.binaryType = 'blob';
				glob[key].dataChannel.onmessage = onDataChannelMessage;
			};

			glob[key].peerConnection.setRemoteDescription(new mozRTCSessionDescription(data["offer"]));
			
			glob[key].peerConnection.createAnswer(function(localDesc) {

				glob[key].peerConnection.setLocalDescription(localDesc);

				setTimeout(function(){
					$.post('http://'+ip+'/send_answer',
						{"key":key,"answer":{"type":localDesc.type,"sdp":localDesc.sdp}});
						askOffer();
				},200);
			},console.error,{});
		}	// gotOffer



		function onDataChannelMessage(event) {
			console.log(event.data)

			if (event.data.match(/^pong_(.+)$/)) {
				var key = RegExp.$1;
				clearTimeout(glob[key].timeoutDisconnect);

				if (!glob[key].flagping) {
					recordVideo(key);
					glob[key].flagping = true;
				}

				glob[key].timeoutDisconnect = setTimeout(function() {
					reset(key);
				},5007);
			}

			else if (event.data.match(/^conversationEnded_(.+)$/))  {
				reset(RegExp.$1);
			}
		}	// onDataChannelMessage
			

			


		function gotRemoteStream(event) {
			var key = event.originalTarget.unofficialID;

			glob[key].remoteStream = event.stream;
			glob[key].remoteVideo.src = URL.createObjectURL(glob[key].remoteStream);
			glob[key].remoteVideo.play();
			glob[key].pingInterval = setInterval(function(){
				try{glob[key].dataChannel.send("ping");}catch(e){}
			},1002);

			glob[key].timeoutDisconnect = setTimeout(function() {
				reset(key);
			},10007)
		}	// gotRemoteStream



		function recordVideo(keyTmp) {
			var key = keyTmp;
			var audioRecorder = new window.MediaRecorder(glob[key].remoteStream);
			var videoResult = [], audioResult;


			audioRecorder.ondataavailable = function(event) {
				if (audioRecorder.state == 'recording') {
					var reader = new FileReader();
					reader.onload = function(e) {
						audioResult = e.target.result;
						glob[key].dataChannel.send(audioResult);
						for (i in videoResult) {
							glob[key].dataChannel.send(videoResult[i]);
							glob[key].dataChannel.send("ping");
						};
						glob[key].dataChannel.send("recording_ended:"+	JSON.stringify({
							"height": recordHeight,
							"width": recordWidth,
							"legth": recordLength,
							"FPS": recordFPS,
						}));
					};
					reader.readAsDataURL(event.data);
					audioRecorder.stop();
				}
			};	// audioRecorder.ondataavailable


			glob[key].intervalVideoRecord = setInterval(function(){
				glob[key].contextVideo.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasVideo.width, glob[key].canvasVideo.height);
				videoResult.push(glob[key].canvasVideo.toDataURL());
			},1000/recordFPS);

			audioRecorder.start(1000*recordLength);

			glob[key].timeoutVideoRecord = setTimeout(function(){
				clearInterval(glob[key].intervalVideoRecord);
			},1000*recordLength);
		}	// revordVideo



		function reset(key) {
			
			deleteElement("video_"+key);
			deleteElement("notif_"+key);

			glob[key].peerConnection.close();

			if (glob[key].pingInterval != null) {
				clearInterval(glob[key].pingInterval);
				glob[key].pingInterval=null;
			}
			if (glob[key].timeoutDisconnect != null) {
				clearTimeout(glob[key].timeoutDisconnect);
				glob[key].timeoutDisconnect=null;
			}
			if (glob[key].intervalVideoRecord != null) {
				clearInterval(glob[key].intervalVideoRecord);
				glob[key].intervalVideoRecord=null;
			}
			if (glob[key].timeoutVideoRecord != null) {
				clearTimeout(glob[key].timeoutVideoRecord);
				glob[key].timeoutVideoRecord=null;
			}

			delete glob[key];
		}	// reset

		function deleteElement(id) {
			var element = document.getElementById(id);
			try{element.parentNode.removeChild(element);}
			catch(err){console.log("Tried to delete element "+id+", did not exist")}
		}	// deleteElement
	</script>
</html>