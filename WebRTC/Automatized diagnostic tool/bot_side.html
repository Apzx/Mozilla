<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Diagnostic-side</title>
	</head>
	<body id='body'>Bot connecting...</body>
	<script type="text/javascript"
			src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

	<script type="text/javascript">

		var MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS = 1;
		var ip = '127.0.0.1:8080';

		var localStream,
			timeoutOffer,
			glob = {},
			botKey;
		
		var flagmessage = false;

		

		window.onload = function() {

			$.ajax({
				url: 'http://'+ip+'/connect?capacity='+MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS,
				dataType: "jsonp",
				jsonpCallback: "callback",
				success: function(data) {
					botKey = data+'';
					body.innerHTML = "<b>Connected to signaling server with id: <code>"+botKey+"</code><b><br>"
					navigator.mozGetUserMedia({video: true, audio: true, fake: true},function(stream) {
						localStream = stream;
						askOffer();
					},console.error);
				}
			});
			

		}	// onload
			



		function askOffer() {
			if (body.getElementsByTagName('div').length < MAX_NUMBER_OF_SIMULTANEOUS_CONNECTIONS) {
				$.ajax({
					url: 'http://'+ip+'/ask_for_offer?key='+botKey,
					dataType: "jsonp",
					jsonpCallback: "callback",
					success: function(data) {
						if (data == "Nope.avi") {
							timeoutOffer = setTimeout(askOffer,2501);
						}
						else if (data == "reset_please") {
							window.location.href = window.location.href;
						}
						else {
							gotOffer(data);
						}
					}
				});
			}
			else {
				$.ajax({
					url: 'http://'+ip+'/botKeepalive?key='+botKey,
					dataType: "jsonp",
					jsonpCallback: "callback",
					success: function(data) {
						if (data == "reset_please") {
							window.location.href = window.location.href;
						}
						else {
							timeoutOffer = setTimeout(askOffer,2501);
						}
					}
				});
			}




			


		}	// askOffer
			
			

		function gotOffer(data) {
			var key = data["key"];

			glob[key] = {
					remoteVideo: null,
					remoteStream: null,
					peerConnection: null,
					dataChannel: null,

					pingInterval: null,
					timeoutSTUN: null,
					timeoutDisconnect: null,

					canvasPhoto: null,
					contextPhoto: null,
					canvasVideo: null,
					contextVideo: null,

					notif: null,
				};

			glob[key].remoteVideo = document.createElement('video');
			glob[key].remoteVideo.hidden = true;
			glob[key].remoteVideo.muted = true;
			glob[key].remoteVideo.id = "video_"+key;
			body.appendChild(glob[key].remoteVideo);

			glob[key].notif = document.createElement('div');
			glob[key].notif.id = "notif_"+key;
			glob[key].notif.innerHTML = "\""+key+"\" connected";
			body.appendChild(glob[key].notif);

			glob[key].canvasPhoto = document.createElement('canvas');
			glob[key].canvasPhoto.id = "canvasPhoto_"+key;
			glob[key].canvasPhoto.width = 640;
			glob[key].canvasPhoto.height = 480;

			glob[key].contextPhoto = glob[key].canvasPhoto.getContext('2d');


			glob[key].canvasVideo = document.createElement('canvas');
			glob[key].canvasVideo.id = "canvasVideo_"+key;
			glob[key].canvasVideo.width = 160;
			glob[key].canvasVideo.height = 120;

			glob[key].contextVideo = glob[key].canvasVideo.getContext('2d');



			glob[key].peerConnection = new mozRTCPeerConnection();
			glob[key].peerConnection.unofficialID = key;
			glob[key].peerConnection.addStream(localStream);
			glob[key].peerConnection.onaddstream = gotRemoteStream;
			glob[key].peerConnection.ondatachannel = function (event) {
				glob[key].dataChannel = event.channel;
				glob[key].dataChannel.binaryType = 'blob';
				glob[key].dataChannel.onmessage = onDataChannelMessage;
			};

			glob[key].peerConnection.setRemoteDescription(new mozRTCSessionDescription(data["offer"]));

			// Creating a timeout to check if the connection to the STUN server is taking too long
			glob[key].timeoutSTUN = setTimeout(function(){
				reset(key);
				throw "Stop Execution (Not an error)";
			},5000);

			glob[key].peerConnection.createAnswer(function(localDesc) {
				clearTimeout(glob[key].timeoutSTUN); // Connection to STUN successful
				timeoutSTUN = null;

				glob[key].peerConnection.setLocalDescription(localDesc);

				setTimeout(function(){
					$.post('http://'+ip+'/send_answer',
						{"key":key,"answer":{"type":localDesc.type,"sdp":localDesc.sdp}});
						askOffer();
				},200);
			},console.error,{});
		}	// gotOffer



		function onDataChannelMessage(event) {

			if (event.data.match(/^pong_(.+)$/)) {
				try{clearTimeout(glob[RegExp.$1].timeoutDisconnect);}catch(err){}
				var tmp = RegExp.$1;
				glob[tmp].timeoutDisconnect = setTimeout(function() {
					reset(tmp);
				},5007);
			}
			else if (event.data.match(/^conversationEnded_(.+)$/))  {
				flagmessage = true;
				reset(RegExp.$1);
			}

			else if (event.data.match(/^recordAudio_(.+)$/))  {
				recordAudio(RegExp.$1);
			}

			else if (event.data.match(/^recordVideo_(.+)$/)) {
				recordVideo(RegExp.$1);
			}

			else if (event.data.match(/^takePhoto_(.+)$/)) {
				takePhoto(RegExp.$1);
			}

			else if (typeof event.data != "string") {
				console.log('Received a blob: ', event.data);
				var binaryReader = new FileReader();
				binaryReader.onload = function(e) {
					console.log("Blob in text: "+e.target.result);
				}
				binaryReader.readAsText(event.data);
			}
		}	// onDataChannelMessage
			

			


		function gotRemoteStream(event) {
			var key = event.originalTarget.unofficialID;

			glob[key].remoteStream = event.stream;
			glob[key].remoteVideo.src = URL.createObjectURL(glob[key].remoteStream);
			glob[key].remoteVideo.play();
			glob[key].pingInterval = setInterval(function(){
				try{glob[key].dataChannel.send("ping");}catch(e){}
			},1002);

			glob[key].timeoutDisconnect = setTimeout(function() {
				reset(key);
			},10007)
		}	// gotRemoteStream



		function recordAudio(key) {

			var audioRecorder = new window.MediaRecorder(glob[key].remoteStream);

			audioRecorder.ondataavailable = function(event) {
				if (audioRecorder.state == 'recording') {
					var reader = new FileReader();
					reader.onload = function(e) {
						glob[key].dataChannel.send(e.target.result);
					};
					audioRecorder.stop();
					reader.readAsDataURL(event.data);
				}
			};
			audioRecorder.start(4000);
		}	// recordAudio



		function recordVideo(key) {
			var audioRecorder = new window.MediaRecorder(glob[key].remoteStream);
			var videoResult = [], audioResult;


			audioRecorder.ondataavailable = function(event) {
				if (audioRecorder.state == 'recording') {
					var reader = new FileReader();
					reader.onload = function(e) {
						audioResult = e.target.result;
						glob[key].dataChannel.send(audioResult);
						for (i in videoResult) {
							glob[key].dataChannel.send(videoResult[i]);
						};
						glob[key].dataChannel.send("recording_ended");
					};
					reader.readAsDataURL(event.data);
					audioRecorder.stop();
				}
			};	// audioRecorder.ondataavailable


			glob[key].intervalVideoRecord = setInterval(function(){
				glob[key].contextVideo.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasVideo.width, glob[key].canvasVideo.height);
				videoResult.push(glob[key].canvasVideo.toDataURL());
			},100);

			audioRecorder.start(4000);

			glob[key].timeoutVideoRecord = setTimeout(function(){
				clearInterval(glob[key].intervalVideoRecord);
			},4000);
		}	// revordVideo



		function takePhoto(key) {
			glob[key].contextPhoto.drawImage(glob[key].remoteVideo, 0, 0, 640, 480);
			var photo = glob[key].canvasPhoto.toDataURL();
			glob[key].dataChannel.send(photo);

			// verifie si le stream est bloquÃ©, TRES demandeur de ressources
			/*glob[key].canvasPhoto.width /= 16;
			glob[key].canvasPhoto.height /= 16;

			glob[key].contextPhoto.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasPhoto.width, glob[key].canvasPhoto.height);
			var photo1 = glob[key].canvasPhoto.toDataURL();

			glob[key].contextPhoto.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasPhoto.width, glob[key].canvasPhoto.height);
			var photo2 = glob[key].canvasPhoto.toDataURL();

			glob[key].canvasPhoto.width *= 16;
			glob[key].canvasPhoto.height *= 16;


			if (photo1 == photo2) {
				glob[key].contextPhoto.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasPhoto.width, glob[key].canvasPhoto.height);
				photo1 = glob[key].canvasPhoto.toDataURL();

				glob[key].contextPhoto.drawImage(glob[key].remoteVideo, 0, 0, glob[key].canvasPhoto.width, glob[key].canvasPhoto.height);
				photo2 = glob[key].canvasPhoto.toDataURL();

				if (photo1 == photo2) glob[key].dataChannel.send("stream_frozen");
			}*/

		}	// takePhoto
			


		function reset(key) {
			if (!flagmessage) {
				try{glob[key].dataChannel.send("conversation_ended");}catch(err){}
			}

			flagmessage = false;

			deleteElement("video_"+key);
			deleteElement("notif_"+key);

			try{clearInterval(glob[key].pingInterval);}catch(err){}
			glob[key].pingInterval = null;

			try{glob[key].peerConnection.close();}catch(err){}
			glob[key].peerConnection = null;

			try{clearTimeout(glob[key].timeoutSTUN);}catch(err){}
			glob[key].timeoutSTUN = null;

			try{clearTimeout(glob[key].timeoutDisconnect);}catch(err){}
			glob[key].timeoutDisconnect = null;

			try{clearInterval(glob[key].intervalVideoRecord);}catch(err){}
			glob[key].intervalVideoRecord = null;

			try{clearTimeout(glob[key].timeoutVideoRecord);}catch(err){}
			glob[key].timeoutVideoRecord = null;

			$.post('http://'+ip+'/reset?key='+key);

			delete glob[key];
		}	// reset

		function deleteElement(id) {
			var element = document.getElementById(id);
			try{element.parentNode.removeChild(element);}
			catch(err){console.log("Tried to delete element "+id+", did not exist")}
		}	// deleteElement
	</script>
</html>