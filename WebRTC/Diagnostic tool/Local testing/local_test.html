<html>
	<head>
		<meta charset=utf-8 />
		<title>Page de Test</title>
		<style>

			#remoteVideo1 {
				border: 1px solid black; 
				position: fixed;
				width: 45%;
				max-height: 75%;
				bottom: 0px;
				left: 0px;
				z-index: 0;
			}

			 #remoteVideo2 {
				border: 1px solid black; 
				position: fixed;
				width: 45%;
				max-height: 75%;
				bottom: 0px;
				right: 0px;
				z-index: 0;
			}

			#localVideo1 {
				border: 1px solid black;
				position: fixed;
				width: 15%;
				max-height: 25%;
				bottom: 0px;
				left:  0px;
				z-index: 1;
				transform: rotateY(180deg);
			}

			#localVideo2 {
				border: 1px solid black;
				position: fixed;
				width: 15%;
				max-height: 25%;
				bottom: 0px;
				right: 0px;
				z-index: 1;
				transform: rotateY(180deg);
			}
		</style>
	</head>
	<body>
		<div id='results'>
			<p id="result1"></p>
		</div>
		
		<video id="localVideo1"></video>
		<video id="remoteVideo1"></video>

		<video id="localVideo2"></video>
		<video id="remoteVideo2"></video>
		
		<script type="text/javascript">

			
			
					// Declaration des variables globales
			var localStream1,
				remoteStream1,
				localStream2,
				remoteStream3,
				pc1,
				pc2,
				browser,
				makePC,
				ok1 = false,
				ok2 = false,
				timeoutID,
				pc1DataChannel,
				pc2DataChannel,
					// Liaison des elements du html
				localVideo1 = document.getElementById("localVideo1"),
				remoteVideo1 = document.getElementById("remoteVideo1"),
				localVideo2 = document.getElementById("localVideo2"),
				remoteVideo2 = document.getElementById("remoteVideo2");
			
			if (navigator.mozGetUserMedia) {
				browser = "firefox";
			}
			else {
				handleError("NOT_MOZ");
			}
			
			localVideo1.muted = 'muted';
			localVideo1.hidden = true;
			
			remoteVideo1.muted = 'muted';
			remoteVideo1.hidden = true;
			
			localVideo2.muted = 'muted';
			localVideo2.hidden = true;
			
			remoteVideo2.muted = 'muted';
			remoteVideo2.hidden = true;
			
			test();
			
			function setChannelEvents(channel, channelName) {
				channel.onmessage = function (event) {
					console.log(channelName, 'received a message:', event.data);
				};
				channel.onopen = function () {
					channel.send('first text message over SCTP data ports');
				};
			}
			
			
			function test() {
				setResult("Getting user media...");
				navigator.mozGetUserMedia({video: true, audio: true},function(stream) {
					localStream1 = stream;
					setResult("Setting up fake stream");
					navigator.mozGetUserMedia({video: true, audio: true, fake: true},function(stream) {
						localStream2 = stream;
						setResult("Testing audio/video tracks...");
						if (localStream1.getAudioTracks().length == 0) {handleError("AUDIO_ERROR");}
						if (localStream1.getVideoTracks().length == 0) {handleError("VIDEO_ERROR");}
			
			
						setResult("Setting pc1...");
						pc1 = new mozRTCPeerConnection();
						pc1.addStream(localStream1);
						pc1.onaddstream = success1;
						pc1DataChannel = pc1.createDataChannel('channel', {});
						pc1DataChannel.binaryType = 'blob';
						setChannelEvents(pc1DataChannel, 'pc1');
			
						setResult("Setting pc2...");
						pc2 = new mozRTCPeerConnection();
						pc2.addStream(localStream2);
						pc2.onaddstream = success2;
						pc2.ondatachannel = function (event) {
							pc2DataChannel = event.channel;
							pc2DataChannel.binaryType = 'blob';
							setChannelEvents(pc2DataChannel, 'pc2');
						};
			
						setResult("Connectiong to internet...");
						var tmpImg = new Image();
						tmpImg.onerror = function() {handleError("CONNECTION_ERROR");}
						tmpImg.onload = function() {
							setResult("Creating offer...");
							timeoutID = setTimeout(function(){
								handleError("STUN_ERROR");
							},2000);
							pc1.createOffer(function(offer) {
								clearTimeout(timeoutID);
								timeoutID = null;
								setResult("Setting pc1 localDescription...");
								console.log(offer)
								pc1.setLocalDescription(offer);
								setResult("Setting pc2 remoteDescription...");
								pc2.setRemoteDescription(new mozRTCSessionDescription(offer));
								setResult("Creating answer...");
								pc2.createAnswer(function(answer) {
									setResult("Setting pc2 localDescription...")
									pc2.setLocalDescription(answer);
									setResult("Setting pc1 remoteDescription...");
									pc1.setRemoteDescription(new mozRTCSessionDescription(answer));
									var tmp = answer.sdp.split('\r\n');
									for (var i=0; i<tmp.length; i++) {
										if (tmp[i].match("candidate")) {
											console.log(tmp[i]);
										}
									}
								},handleError,{});
							},handleError,{});
						}
						tmpImg.src = "http://www.google.com/favicon.ico?cachebypass="+Math.floor(Math.r			andom()*1000000000);
					},handleError);
				},handleError);
			}
			
			
			
			function success1(event) {
				localVideo1.src = URL.createObjectURL(localStream1);
				localVideo1.play();
				localVideo1.hidden = false;
				
				remoteStream1 = event.stream;
				remoteVideo1.src = URL.createObjectURL(remoteStream1);
				remoteVideo1.play();
				remoteVideo1.hidden = false;
			
				if (ok2) {
					setResult("Localy, everything's good:<br>"+
							"- getUserMedia<br>"+
							"- Hardware<br>"+
							"- Connection to STUN default server<br>"+
							"- PeerConnection mecanics<br>"+
							"- CPU/GPU usage<br><br>"+
							"Left to test<br>"+
							"- Data Quality<br>"+
							"- Bandiwdth",true);
				}
				else {
					ok1 = true;
					setResult("Success on local view. waiting for remote...")
				}
			}
			
			
			function success2(event) {
				localVideo2.src = URL.createObjectURL(localStream2);
				localVideo2.play();
				localVideo2.hidden = false;
				
				remoteStream2 = event.stream;
				remoteVideo2.src = URL.createObjectURL(remoteStream2);
				remoteVideo2.play();
				remoteVideo2.hidden = false;
			
				if (ok1) {
					setResult("Localy, everything's good:<br>"+
							"- getUserMedia<br>"+
							"- Hardware<br>"+
							"- Connection to STUN default server<br>"+
							"- PeerConnection mecanics<br>"+
							"- CPU/GPU usage<br><br>"+
							"Left to test<br>"+
							"- Data Quality<br>"+
							"- Bandiwdth",true);
				}
				else {
					ok2 = true;
					setResult("Success on remote view. waiting for local...")
				}
			}
			
			function hangUp() {
				localVideo1.hidden = true;
				localVideo1.pause();
				localStream1 = null;
			
				remoteVideo1.hidden = true;
				remoteVideo1.pause();
				remoteStream1 = null;
			
				localVideo2.hidden = true;
				localVideo2.pause();
				localStream2 = null;
			
				remoteVideo2.hidden = true;
				remoteVideo2.pause();
				remoteStream2 = null;
			
				try{pc1.close();}catch(err){}
				try{pc2.close();}catch(err){}
			
				throw "This is not an error: Stop js execution"
				
			}
			
			
			
			function handleError (err) {
				switch (err) {
					case "NOT_MOZ":
						setResult("This test is engineered to be used on Firefox",false);
						break;
			
					case "AUDIO_ERROR":
						setResult("Could not get the audio",false);
						break;
			
					case "VIDEO_ERROR":
						setResult("Could not get the video",false);
						break;
			
					case "PERMISSION_DENIED":
						setResult("Could not get the video/audio authorization",false);
						break;
			
					case "HARDWARE_UNAVAILABLE":
						setResult("Your input device(s) is/are alerady in use<br>Please close the process 			using them and try again",false);
						break;
			
					case "CONNECTION_ERROR":
						setResult("Could not connect to internet",false);
						break;
			
					case "STUN_ERROR":
						setResult("Could not connect to STUN server",false);
						brek;
						
			
					default:
						setResult("The following error occured:<br>"+err);
						console.log(err);
				}
				hangUp();
			}
			
			
			
			function setResult(string, success) {
				document.getElementById("result1").innerHTML = string;
				if (success === undefined) {}
				else if (success == true) {
					document.getElementById("result1").style = "color:green"
				}
				else if (success == false) {
					document.getElementById("result1").style = "color:red"
				}
			}
		</script>
	</body>
</html>