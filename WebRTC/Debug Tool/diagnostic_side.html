<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Diagnostic-side</title>
		<style>		
			body {
				font-family: calibri, arial;
			}
			#localVideo {
				border: 1px solid black;
				position: fixed;
				height: 30%;
				max-width: 50%;
				bottom: 0px;
				right: 0px;
				z-index: 1;
				transform: rotateY(180deg);
			}
			
			#remoteVideo {
				border: 1px solid black;
				position: fixed;
				max-width: 50%;
				height: 30%;
				bottom: 30%;
				right: 0px;
				z-index: 0;
			}

			#container {
				position: fixed;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 350px;
				background: rgba(0, 0, 255, 0.2);
				padding-left: 20px;
				box-shadow: 0px 0px 5px #222222;
			}


			#logdiv {
				position: fixed;
				left: 400px;
				top: 20px;
				line-height: 12px;
				overflow-y: auto;
				width: 50%;
				height: 95%;
			}

			#pingdiv {
				position: fixed;
				left: 20px;
				bottom: 50px;
			}

			#bottomlog {
				position: fixed;
				bottom: 20px;
				left: 400px;
			}
		</style>
	</head>

	<video id="localVideo" hidden=true></video>
	<video id="remoteVideo" hidden=true></video>
	<canvas id="canvas" hidden></canvas>

	<body bgcolor="#EEEEFF">
		<div id="container">
			<h2>User-side of my WebRTC tool</h2>
		
			<p id="step"><b>State: </b>Waiting for medias</p>
			<input type="text" id="keyForm" value="" hidden=true placeholder="Room key">
			<button id="button" hidden=true></button>
			
			<br><br><br><br>
			<button id="offerButton">Show offer</button>
			<button id="answerButton">Show answer</button>
			<button onclick="logdiv.innerHTML = '';">Clear log</button>
			<br><br>
			<div id="pingdiv">Ping:</div>
		</div>
		<div id="logdiv"></div>
		<div id="bottomlog">
			<b>
				<table id="iptable" CELLPADDING="3" hidden=true>
				<tr>
					<td>Local<br>Remote</td>
					<td>private IP:<br>private IP:</td>
					<td id="hostIP"></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>Local<br>Remote</td>
					<td>public IP:<br>public IP:</td>
					<td id="stunIP"></td>
				</tr>
			</b>
			<div style="color:red;font-size: 150%;" id="relevancy"></div>
		</div>
	</body>

	<script type="text/javascript"
			src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

	<script type="text/javascript">

		var localStream,
			remoteStream,
			offer,
			answer,
			peerConnection,
			dataChannel;

		var pingInterval,
			pingDate,
			ping = 0;

		var key;
		
		var flagmessage = false;

		var ip = 'rtctest.lolnet.org';

		var	timeoutSTUN,
			intervalOffer,
			timeoutDisconnect;

		var context = canvas.getContext('2d'),
			canvasWidth = 640,
			canvasHeight = 480;

		canvas.width = canvasWidth;
		canvas.height = canvasHeight;

		localVideo.muted = 'muted';
		remoteVideo.muted = 'muted';
			



		window.onload = function() {

			offerButton.onclick = function() {
					if (offer!=null) {
						logdiv.innerHTML = "<b>Offer:</b><br><br><code>" + 
											offer.sdp.replace(/\r\n/g,"<br>").replace(/<br>m=/g,'<br><br>m=')+"</code>";
					} else {
						logdiv.innerHTML = "No offer available";
					}
				}
				
				
			answerButton.onclick = function() {
				if (answer!=null) {
					logdiv.innerHTML = "<b>Offer:</b><br><br><code>" + 
										answer.sdp.replace(/\r\n/g,"<br>").replace(/<br>m=/g,'<br><br>m=')+"</code>";
				} else {
					logdiv.innerHTML = "No answer available";
				}
			}


			navigator.mozGetUserMedia({video: true, audio: true},function(stream) {
				localStream = stream;
				localVideo.src = URL.createObjectURL(localStream);
				localVideo.play();
				localVideo.hidden = false;
				keyForm.hidden = false;
				step.innerHTML = "<b>State: </b>Waiting for a room key...";
			
				button.hidden = false;
				button.onclick = start;
				button.innerHTML = "Initiate call";
			},console.error);
		}	// onload
			


		function start() {
			button.onclick = reset;
			button.innerHTML = "Reset"

			keyForm.hidden = true;
			key = keyForm.value;

			step.innerHTML = "<b>State: </b>Asking server for offer with key \"<code>" + 
							key + "</code>\" ...";
			intervalOffer = setInterval(askOffer,1501);
		}	// start
			


		function askOffer() {
			$.ajax({
				url: 'http://'+ip+'/ask_for_offer?key='+key,
				dataType: "jsonp",
				jsonpCallback: "callback",
				success: function(data) {
					offer = data;
					if (offer != "Nope.avi") {gotOffer();}
				}
			});
		}	// askOffer
			
			

		function gotOffer() {
			clearInterval(intervalOffer);
			intervalOffer = null;
			step.innerHTML = "<b>State: </b>Setting up peerConnection...";

			peerConnection = new mozRTCPeerConnection();
			peerConnection.addStream(localStream);
			peerConnection.onaddstream = gotRemoteStream;
			peerConnection.ondatachannel = function (event) {
				dataChannel = event.channel;
				dataChannel.binaryType = 'blob';

				dataChannel.onmessage = onDataChannelMessage;

			};

			peerConnection.setRemoteDescription(new mozRTCSessionDescription(offer));

			step.innerHTML = "<b>State: </b>Creating answer...";
			// Creating a timeout to check if the connection to the STUN server is taking too long
			timeoutSTUN = setTimeout(function(){
				var tmpkey = key;
				reset();
				key = tmpkey;
				keyForm.hidden = true;

				step.innerHTML = "<font color='red'>Could not connect to stun server</font>";
				button.innerHTML = "Try again";

				throw "Stop Execution (Not an error)";
			},5000);

			peerConnection.createAnswer(function(localDesc) {
				clearTimeout(timeoutSTUN); // Connection to STUN successful
				timeoutSTUN = null;

				answer = localDesc;

				step.innerHTML = "<b>State: </b>Setting localDescription...";
				peerConnection.setLocalDescription(answer);

				step.innerHTML = "<b>State: </b>Sending answer...";
				setTimeout(function(){
					$.post('http://'+ip+'/send_answer',
						{"key":key,"answer":{"type":answer.type,"sdp":answer.sdp}});
						// Weird bug with FF>22, decomposing the JSON bypasses the problem
				},2000);

				compareSDP();
			},console.error,{});
		}	// gotOffer



		function onDataChannelMessage(event) {
			if (event.data == "pong") {
				ping = new Date().getTime() - pingDate;
				pingDate = null;
				pingdiv.innerHTML = "Ping:";
				setTimeout(function(){pingdiv.innerHTML = "Ping: "+ping+" ms";},20);
							
				try{clearTimeout(timeoutDisconnect);}catch(err){}
				
				timeoutDisconnect = setTimeout(function() {
					reset();
					step.innerHTML = "<b>State: </b><font color='red'>Connection Timeout</font>";
				},5007);
			}
			else if (event.data == "conversation_ended")  {
				flagmessage = true;
				reset();
			}

			else if (event.data.match(/^recordAudio_([0-9]{3,5})$/))  {
				recordAudio(RegExp.$1);
			}

			else if (event.data.match(/^recordVideo_([0-9]{3,5})$/)) {
				recordVideo(RegExp.$1);
			}

			else if (event.data == "takePhoto") {
				takePhoto();
			}

			else if (typeof event.data != "string") {
				console.log('Received a blob: ', event.data);
				var binaryReader = new FileReader();
				binaryReader.onload = function(e) {
					console.log("Blob in text: "+e.target.result);
				}
				binaryReader.readAsText(event.data);
			}
		}	// onDataChannelMessage
			


		function compareSDP() {
			var localHostIP = "";
			var remoteHostIP = "";
			var localSrflxIP = "";
			var remoteSrflxIP = "";


			// Code duplication, couldnt find a way without
			var tmpsdp = answer.sdp;
			var gotIP = true;
			while (gotIP) {
				/a=candidate:[0-3] [1-2] UDP [0-9]+ (.+?) [0-9]+ typ host/.exec(tmpsdp);
				localHostIP += ((localHostIP!="" && RegExp.$1!="")?', ':'');
				gotIP = (RegExp.$1!="");
				localHostIP += RegExp.$1;
				tmpsdp = tmpsdp.replace(new RegExp(RegExp.$1,'g'),"");
			}

			tmpsdp = offer.sdp;
			gotIP = true;
			while (gotIP) {
				/a=candidate:[0-3] [1-2] UDP [0-9]+ (.+?) [0-9]+ typ host/.exec(tmpsdp);
				remoteHostIP += ((remoteHostIP!="" && RegExp.$1!="")?', ':'');
				gotIP = (RegExp.$1!="");
				remoteHostIP += RegExp.$1;
				tmpsdp = tmpsdp.replace(new RegExp(RegExp.$1,'g'),"");
			}

			tmpsdp = answer.sdp;
			gotIP = true;
			while (gotIP) {
				/a=candidate:[0-3] [1-2] UDP [0-9]+ (.+) [0-9]+ typ srflx/.exec(tmpsdp);
				localSrflxIP += ((localSrflxIP!="" && RegExp.$1!="")?', ':'');
				gotIP = (RegExp.$1!="");
				localSrflxIP += RegExp.$1;
				tmpsdp = tmpsdp.replace(new RegExp(RegExp.$1,'g'),"");
			}

			tmpsdp = offer.sdp;
			gotIP = true;
			while (gotIP) {
				/a=candidate:[0-3] [1-2] UDP [0-9]+ (.+) [0-9]+ typ srflx/.exec(tmpsdp);
				remoteSrflxIP += ((remoteSrflxIP!="" && RegExp.$1!="")?', ':'');
				gotIP = (RegExp.$1!="");
				remoteSrflxIP += RegExp.$1;
				tmpsdp = tmpsdp.replace(new RegExp(RegExp.$1,'g'),"");
			}
				

				

			if (remoteHostIP==localHostIP && remoteSrflxIP==localSrflxIP) {
				relevancy.innerHTML = "<b>This test might be irrelevant; both ends of the conversation seem to be on the same machine</b>";
			} 
			else if (remoteSrflxIP==localSrflxIP) {
				relevancy.innerHTML = "<b>This test might be irrelevant; both ends of the conversation seem to be behind the same NAT</b>";
			}

			hostIP.innerHTML = localHostIP+"<br>"+remoteHostIP;

			stunIP.innerHTML = localSrflxIP+"<br>"+remoteSrflxIP;

			iptable.hidden = false;
		}	// compareSDP
			


		function gotRemoteStream(event) {
			step.innerHTML = "<b>State: </b>Communication etablished";

			remoteStream = event.stream;
			remoteVideo.src = URL.createObjectURL(remoteStream);
			remoteVideo.play();
			remoteVideo.hidden = false;
			pingInterval = setInterval(function(){
				pingDate = new Date().getTime();
				try{dataChannel.send("ping");}catch(e){}
			},1002);

			timeoutDisconnect = setTimeout(function() {
				reset();
				step.innerHTML = "<b>State: </b><font color='red'>DataChannel could not be etablished</font>";
			},10007)
		}	// gotRemoteStream
			


		function recordAudio(length) {
			var audioRecorder = new window.MediaRecorder(remoteStream);

			audioRecorder.ondataavailable = function(event) {
				if (audioRecorder.state == 'recording') {
					var reader = new FileReader();
					reader.onload = function(e) {
						dataChannel.send(e.target.result);						
					};
					audioRecorder.stop();
					reader.readAsDataURL(event.data);
				}
			};

			audioRecorder.onstop = function() {
				audioRecorder = null;
			};

			audioRecorder.start(length);
		}	// recordAudio



		function recordVideo(length) {
			// Video recording not suported yet
		}



		function takePhoto() {
			canvas.hidden = false;
			context.drawImage(remoteVideo,0,0,canvasWidth,canvasHeight);
			dataChannel.send(canvas.toDataURL());
			canvas.hidden = true;
		}	// takePhoto
			


		function reset() {
			remoteVideo.hidden = true;
			remoteStream = null;

			offer = null;
			answer = null;

			try{clearInterval(pingInterval);}catch(err){}
			pingInterval = null;

			if (!flagmessage) {
				try{dataChannel.send("conversation_ended");}catch(err){}
			}

			flagmessage = false;

			try{peerConnection.close();}catch(err){}
			peerConnection = null;

			try{clearInterval(intervalOffer);}catch(err){}
			intervalOffer = null;

			try{clearTimeout(timeoutSTUN);}catch(err){}
			timeoutSTUN = null;

			try{clearTimeout(timeoutDisconnect);}catch(err){}
			timeoutDisconnect = null;
			$.post('http://'+ip+'/reset?key='+key);

			key = null;
			keyForm.hidden = false;

			step.innerHTML = "<b>State: </b>Call ended";
			button.onclick = start;
			button.innerHTML = "Initiate call";

			relevancy.innerHTML = "";
			logdiv.innerHTML = "";
			hostIP.innerHTML = "";
			stunIP.innerHTML = "";
			iptable.hidden = true;

			pingdiv.innerHTML = "Ping:";
		}	// reset


	</script>
</html>